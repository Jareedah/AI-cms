{"id":4131,"date":"2019-03-24T18:20:37","date_gmt":"2019-03-24T18:20:37","guid":{"rendered":"https:\/\/help.perfexcrm.com\/?p=4131"},"modified":"2022-01-19T10:28:29","modified_gmt":"2022-01-19T10:28:29","slug":"module-as-payment-gateway","status":"publish","type":"post","link":"https:\/\/help.perfexcrm.com\/module-as-payment-gateway\/","title":{"rendered":"Module as Payment Gateway"},"content":{"rendered":"\n<div class=\"st-alert st-alert- \">This feature is available from version 2.3.4<\/div>\n\n\n\n<p>Before the start, we assume that you are already familiar with the <a href=\"https:\/\/help.perfexcrm.com\/module-basics\/\">modules basics<\/a>,&nbsp;you created a blank module with all the required <a href=\"https:\/\/help.perfexcrm.com\/module-file-headers\/\">headers<\/a>, and <strong>the module is activated<\/strong> and shown in the modules list.<\/p>\n\n\n\n<ul class=\"wp-block-list\"><li>In <strong>modules\/[module_name]\/<\/strong> create folder named <strong>libraries<\/strong><\/li><li>In modules\/[module_name]\/<strong>libraries <\/strong>create a class name e.q. <strong>Example_gateway.php<\/strong>, the <strong>filename must end with _gateway.php<\/strong><\/li><li>See below <strong><a href=\"https:\/\/help.perfexcrm.com\/module-as-payment-gateway\/#sample-implementation\">Sample implementation<\/a><\/strong><\/li><li>In your module init file, register the payment gateway with the following code:<\/li><\/ul>\n\n\n\n<pre class=\"wp-block-code\"><code>register_payment_gateway('example_gateway', '&#091;module_name]');<\/code><\/pre>\n\n\n\n<p>Replace <strong>[module_name] <\/strong>with your actual module system name and <strong>example_gateway <\/strong>with your module class name (in lowercase).<\/p>\n\n\n\n<p>If you configured everything as it should, navigate to <strong>Setup-&gt;Settings-&gt;Payment Gateways<\/strong>, you will be able to see your <strong>Example <\/strong>gateway listed there with the options you specified.<\/p>\n\n\n\n<p>Additionally, depends on the gateway API, you can create <a href=\"https:\/\/help.perfexcrm.com\/module-controllers\/\">a controller <\/a>to redirect from the <strong>process_payment <\/strong>gateway class method.<\/p>\n\n\n\n<h3 class=\"wp-block-heading\">Sample Implementation<\/h3>\n\n\n\n<p>Because Perfex CRM uses Codeigniter framework to integrate the payment gateway you will need to create 1 gateway library (gateway config and process method) and 1 gateway controller (for HTTP requests, show form <g class=\"gr_ gr_4 gr-alert gr_gramm gr_inline_cards gr_run_anim Punctuation only-ins replaceWithoutSep\" id=\"4\" data-gr-id=\"4\">etc<\/g>..), you can also take a look at the other gateways files in order to get the idea. <\/p>\n\n\n\n<p>In the invoice HTML area when a customer clicks on the button <strong>PAY NOW<\/strong>, <strong>we call 1 method from the gateway library<\/strong> which will process everything additional that is required for this gateway eq redirect to gateway website and pass parameters or redirect to&nbsp;<a href=\"https:\/\/help.perfexcrm.com\/module-controllers\/\">controller&nbsp;<\/a>and show form etc\u2026 <\/p>\n\n\n\n<p>We have simplified a little the process for creating new gateways e.q. the gateway will be auto showed in <strong>Setup-&gt;Settings-&gt;Payment Gateways<\/strong>, encrypting fields, 1 unique function from each gateway library to call <g class=\"gr_ gr_7 gr-alert gr_gramm gr_inline_cards gr_run_anim Punctuation only-ins replaceWithoutSep\" id=\"7\" data-gr-id=\"7\"><g class=\"gr_ gr_7 gr-alert gr_gramm gr_inline_cards gr_run_anim Punctuation only-ins replaceWithoutSep\" id=\"7\" data-gr-id=\"7\">etc<\/g><\/g>\u2026 but this will still require effort to get started.<\/p>\n\n\n\n<div class=\"st-alert st-alert-info \">Before start, make sure that you set <a href=\"https:\/\/help.perfexcrm.com\/faq\/how-to-set-debug-mode\/\">development mode<\/a> in order to see any errors and functions\/hooks deprecation warnings.<\/div>\n\n\n\n<p>Let&#8217;s assume for this example your gateway name is <strong>Example<\/strong><\/p>\n\n\n\n<pre class=\"wp-block-code\"><code>&lt;?php\n\ndefined('BASEPATH') or exit('No direct script access allowed');\n\nclass Example_gateway extends App_gateway\n{\n&nbsp; &nbsp; public function __construct()\n&nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; \/**\n&nbsp; &nbsp; &nbsp; &nbsp; * Call App_gateway __construct function\n&nbsp; &nbsp; &nbsp; &nbsp; *\/\n&nbsp; &nbsp; &nbsp; &nbsp; parent::__construct();\n\n&nbsp; &nbsp; &nbsp; &nbsp; \/**\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Gateway unique id - REQUIRED\n\t * \n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* * The ID must be alphanumeric\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* * The filename (Example_gateway.php) and the class name must contain the id as ID_gateway\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* * In this case our id is \"example\"\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* * Filename will be Example_gateway.php (first letter is uppercase)\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* * Class name will be Example_gateway (first letter is uppercase)\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*\/\n&nbsp; &nbsp; &nbsp; &nbsp; $this-&gt;setId('example');\n\n&nbsp; &nbsp; &nbsp; &nbsp; \/**\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* REQUIRED\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Gateway name\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*\/\n&nbsp; &nbsp; &nbsp; &nbsp; $this-&gt;setName('Example');\n\n&nbsp; &nbsp; &nbsp; &nbsp; \/**\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Add gateway settings\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* You can add other settings here \n         * to fit for your gateway requirements\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* Currently only 3 field types are accepted for gateway\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* 'type'=&gt;'yes_no'\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;* 'type'=&gt;'input'\n         * 'type'=&gt;'textarea'\n         *\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;*\/\n&nbsp; &nbsp; &nbsp; &nbsp; $this-&gt;setSettings(array(\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array(\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'name' =&gt; 'api_secret_key',\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'encrypted' =&gt; true,\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'label' =&gt; 'API KEY',\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'type'=&gt;'input',\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ),\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array(\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'name' =&gt; 'api_publishable_key',\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'label' =&gt; 'SECRET KEY',\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'type'=&gt;'input'\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ),\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; array(\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'name' =&gt; 'currencies',\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'label' =&gt; 'settings_paymentmethod_currencies',\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'default_value' =&gt; 'USD,CAD'\n&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ),\n&nbsp; &nbsp; &nbsp; &nbsp; ));\n\n&nbsp; &nbsp; }\n\n&nbsp; &nbsp; \/**\n&nbsp; &nbsp; &nbsp;* Each time a customer click PAY NOW button on the invoice HTML area, the script will process the payment via this function.\n&nbsp; &nbsp; &nbsp;* You can show forms here, redirect to gateway website, redirect to Codeigniter controller etc..\n&nbsp; &nbsp; &nbsp;* @param&nbsp; array $data - Contains the total amount to pay and the invoice information\n&nbsp; &nbsp; &nbsp;* @return mixed\n&nbsp; &nbsp; &nbsp;*\/\n&nbsp; &nbsp; public function process_payment($data)\n&nbsp; &nbsp; {\n&nbsp; &nbsp; &nbsp; &nbsp; var_dump($data);\n&nbsp; &nbsp; &nbsp; &nbsp; die;\n&nbsp; &nbsp; }\n}<\/code><\/pre>\n\n\n\n<p><strong>There are comments on the functions and variables, you should spend some time to read them because they are important if you want to help you get started.<\/strong><\/p>\n\n\n\n<p>Additionally, you can take a look at the other gateway example in <strong>application\/libraries\/gateways<\/strong> or <strong>application\/controllers\/gateways<\/strong>. <\/p>\n\n\n\n<h3 class=\"wp-block-heading\">Excluding URL from CSRF<\/h3>\n\n\n\n<p>If the module payment gateway is using webhooks and makes a POST request to a URL in Perfex CRM to notify about the payment updates, you will need to exclude this URL from CSRF in order for the request to pass.<\/p>\n\n\n\n<p>You can follow <a href=\"https:\/\/help.perfexcrm.com\/working-with-forms\/#exclude-url-from-csrf-v2-9-0\" title=\"this\">this<\/a> guide in order to achieve this. <\/p>\n","protected":false},"excerpt":{"rendered":"<p>Before the start, we assume that you are already familiar with the modules basics,&nbsp;you created a blank module with all the required headers, and the module is activated and shown in the modules list. In modules\/[module_name]\/ create folder named libraries In modules\/[module_name]\/libraries create a class name e.q. Example_gateway.php, the filename must end with _gateway.php See [&hellip;]<\/p>\n","protected":false},"author":1,"featured_media":0,"comment_status":"closed","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"footnotes":""},"categories":[54],"tags":[],"class_list":["post-4131","post","type-post","status-publish","format-standard","hentry","category-modules"],"aioseo_notices":[],"_links":{"self":[{"href":"https:\/\/help.perfexcrm.com\/wp-json\/wp\/v2\/posts\/4131","targetHints":{"allow":["GET"]}}],"collection":[{"href":"https:\/\/help.perfexcrm.com\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/help.perfexcrm.com\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/help.perfexcrm.com\/wp-json\/wp\/v2\/users\/1"}],"replies":[{"embeddable":true,"href":"https:\/\/help.perfexcrm.com\/wp-json\/wp\/v2\/comments?post=4131"}],"version-history":[{"count":0,"href":"https:\/\/help.perfexcrm.com\/wp-json\/wp\/v2\/posts\/4131\/revisions"}],"wp:attachment":[{"href":"https:\/\/help.perfexcrm.com\/wp-json\/wp\/v2\/media?parent=4131"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/help.perfexcrm.com\/wp-json\/wp\/v2\/categories?post=4131"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/help.perfexcrm.com\/wp-json\/wp\/v2\/tags?post=4131"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}